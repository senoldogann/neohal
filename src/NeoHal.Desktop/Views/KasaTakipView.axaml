<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:NeoHal.Desktop.ViewModels"
             xmlns:m="using:NeoHal.Core.Entities"
             x:Class="NeoHal.Desktop.Views.KasaTakipView"
             x:DataType="vm:KasaTakipViewModel"
             Name="KasaTakipRoot">
    
    <Grid RowDefinitions="Auto,*,Auto">
        
        <!-- BaÅŸlÄ±k ve Filtre -->
        <Border Grid.Row="0" Background="{DynamicResource BackgroundMediumBrush}" Padding="20,15">
            <Grid RowDefinitions="Auto,Auto">
                <Grid Grid.Row="0" ColumnDefinitions="*,Auto,Auto,Auto">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="15">
                        <TextBlock Text="ðŸ“¦ Kasa Takip ve Rehin FiÅŸleri" FontSize="22" FontWeight="Bold" VerticalAlignment="Center"/>
                    </StackPanel>
                    
                    <Button Grid.Column="1" Content="ðŸ“¥ Rehin Al" 
                            Command="{Binding YeniRehinAlCommand}"
                            Background="#4CAF50" Foreground="White" 
                            Padding="20,10" FontSize="14" FontWeight="SemiBold"
                            Margin="10,0"/>
                    
                    <Button Grid.Column="2" Content="ðŸ“¤ Rehin Ä°ade" 
                            Command="{Binding YeniRehinIadeCommand}"
                            Background="{DynamicResource WarningBrush}" Foreground="White" 
                            Padding="20,10" FontSize="14" FontWeight="SemiBold"
                            Margin="10,0"/>
                    
                    <Button Grid.Column="3" Content="ðŸ”„ Yenile" 
                            Command="{Binding YenileCommand}"
                            Padding="15,10"/>
                </Grid>
                
                <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="15" Margin="0,15,0,0">
                    <TextBlock Text="Tarih AralÄ±ÄŸÄ±:" VerticalAlignment="Center" Foreground="#aaa"/>
                    <DatePicker SelectedDate="{Binding FiltreBaslangic}" Width="200"/>
                    <TextBlock Text="-" VerticalAlignment="Center" Margin="10,0"/>
                    <DatePicker SelectedDate="{Binding FiltreBitis}" Width="200"/>
                    <Button Content="ðŸ” Filtrele" Command="{Binding YenileCommand}" 
                            Background="#2196F3" Foreground="White" Padding="15,8"/>
                    <TextBlock Text="{Binding StatusMessage}" 
                               Foreground="#888" VerticalAlignment="Center" Margin="20,0,0,0"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Rehin FiÅŸleri DataGrid -->
        <DataGrid Grid.Row="1" 
                  ItemsSource="{Binding RehinFisleri}" 
                  SelectedItem="{Binding SelectedRehinFisi}"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  GridLinesVisibility="Horizontal"
                  BorderThickness="0"
                  CanUserResizeColumns="True"
                  CanUserSortColumns="True"
                  SelectionMode="Single">
            <DataGrid.Columns>
                <DataGridTextColumn Header="FiÅŸ No" Binding="{Binding FisNo}" Width="120" MinWidth="80"/>
                <DataGridTextColumn Header="Tarih" Binding="{Binding Tarih, StringFormat=dd.MM.yyyy}" Width="100" MinWidth="80"/>
                <DataGridTemplateColumn Header="Ä°ÅŸlem" Width="80" MinWidth="60">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Border Background="{Binding IslemTipiAl, Converter={x:Static ObjectConverters.IsNotNull}}"
                                    Padding="5,2" CornerRadius="3" HorizontalAlignment="Center">
                                <TextBlock Text="{Binding IslemTipiAl}" VerticalAlignment="Center"/>
                            </Border>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
                <DataGridTextColumn Header="Cari" Binding="{Binding Cari.Unvan}" Width="200" MinWidth="120"/>
                <DataGridTextColumn Header="Kap Tipi" Binding="{Binding KapTipi.Ad}" Width="100" MinWidth="80"/>
                <DataGridTextColumn Header="Adet" Binding="{Binding KasaAdet}" Width="70" MinWidth="50"/>
                <DataGridTextColumn Header="Birim" Binding="{Binding BirimBedel, StringFormat=â‚º{0:N2}}" Width="90" MinWidth="70"/>
                <DataGridTextColumn Header="Toplam" Binding="{Binding ToplamTutar, StringFormat=â‚º{0:N2}}" Width="110" MinWidth="80"/>
                <DataGridCheckBoxColumn Header="Ã–dendi" Binding="{Binding Odendi}" Width="70" MinWidth="60"/>
                <DataGridTextColumn Header="AÃ§Ä±klama" Binding="{Binding Aciklama}" Width="200" MinWidth="100"/>
            </DataGrid.Columns>
        </DataGrid>
        
        <!-- Alt Bar: Ã–zet Bilgiler -->
        <Border Grid.Row="2" Background="{DynamicResource BackgroundMediumBrush}" Padding="20,15">
            <Grid ColumnDefinitions="Auto,Auto,Auto,*,Auto">
                <Border Grid.Column="0" Background="#4CAF50" CornerRadius="8" Padding="20,10" Margin="0,0,15,0">
                    <StackPanel>
                        <TextBlock Text="TOPLAM REHÄ°N ALACAK" Foreground="#c8e6c9" FontSize="10"/>
                        <TextBlock Text="{Binding ToplamRehinAlacak, StringFormat=â‚º{0:N2}}" 
                                   FontSize="20" FontWeight="Bold" Foreground="White"/>
                    </StackPanel>
                </Border>
                
                <Border Grid.Column="1" Background="{DynamicResource WarningBrush}" CornerRadius="8" Padding="20,10" Margin="0,0,15,0">
                    <StackPanel>
                        <TextBlock Text="TOPLAM REHÄ°N VERÄ°LECEK" Foreground="#ffe0b2" FontSize="10"/>
                        <TextBlock Text="{Binding ToplamRehinVerecek, StringFormat=â‚º{0:N2}}" 
                                   FontSize="20" FontWeight="Bold" Foreground="White"/>
                    </StackPanel>
                </Border>
                
                <Border Grid.Column="2" Background="#2196F3" CornerRadius="8" Padding="20,10">
                    <StackPanel>
                        <TextBlock Text="NET REHÄ°N BAKÄ°YE" Foreground="#bbdefb" FontSize="10"/>
                        <TextBlock Text="{Binding NetRehin, StringFormat=â‚º{0:N2}}" 
                                   FontSize="20" FontWeight="Bold" Foreground="White"/>
                    </StackPanel>
                </Border>
                
                <Panel Grid.Column="3"/>
                
                <TextBlock Grid.Column="4" Text="{Binding RehinFisleri.Count, StringFormat='{}{0} fiÅŸ'}" 
                           Foreground="#888" VerticalAlignment="Center"/>
            </Grid>
        </Border>
        
        <!-- REHÄ°N DIALOG -->
        <Border Grid.RowSpan="3" 
                Background="#80000000" 
                IsVisible="{Binding RehinDialogAcik}">
            <Border Background="{DynamicResource BackgroundMediumBrush}" 
                    CornerRadius="10" 
                    Width="450" 
                    VerticalAlignment="Center"
                    HorizontalAlignment="Center"
                    Padding="25">
                <StackPanel Spacing="15">
                    <!-- Header -->
                    <StackPanel>
                        <TextBlock Text="ðŸ“¥ REHÄ°N AL / ðŸ“¤ REHÄ°N Ä°ADE" FontSize="18" FontWeight="Bold" Foreground="#4CAF50"/>
                    </StackPanel>
                    
                    <!-- Cari SeÃ§imi -->
                    <StackPanel>
                        <TextBlock Text="Cari Hesap" Foreground="Gray" FontSize="11"/>
                        <ComboBox ItemsSource="{Binding Cariler}"
                                  PlaceholderText="Cari seÃ§..."
                                  SelectedItem="{Binding SelectedCari}"
                                  IsTextSearchEnabled="True">
                            <ComboBox.ItemTemplate>
                                <DataTemplate x:DataType="m:CariHesap">
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <TextBlock Text="{Binding Kod}" Foreground="Gray" Width="80"/>
                                        <TextBlock Text="{Binding Unvan}" FontWeight="Bold"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>
                    
                    <!-- Kap Tipi SeÃ§imi -->
                    <StackPanel>
                        <TextBlock Text="Kap Tipi" Foreground="Gray" FontSize="11"/>
                        <AutoCompleteBox ItemsSource="{Binding KapTipleri}"
                                         SelectedItem="{Binding SelectedKapTipi}"
                                         FilterMode="ContainsOrdinal"
                                         MinimumPrefixLength="0"
                                         Watermark="KÃœÃ‡, PLA..."
                                         ValueMemberBinding="{Binding Ad}">
                            <AutoCompleteBox.ItemTemplate>
                                <DataTemplate x:DataType="m:KapTipi">
                                    <StackPanel Orientation="Horizontal" Spacing="10">
                                        <TextBlock Text="{Binding Kod}" Foreground="#FF9800" Width="40"/>
                                        <TextBlock Text="{Binding Ad}" FontWeight="Bold"/>
                                        <TextBlock Text="{Binding RehinBedeli, StringFormat='(â‚º{0:N2})'}" Foreground="#4CAF50"/>
                                    </StackPanel>
                                </DataTemplate>
                            </AutoCompleteBox.ItemTemplate>
                        </AutoCompleteBox>
                    </StackPanel>
                    
                    <!-- Kasa Adedi -->
                    <StackPanel>
                        <TextBlock Text="Kasa Adedi" Foreground="Gray" FontSize="11"/>
                        <NumericUpDown Value="{Binding KasaAdet}" 
                                       Minimum="1" 
                                       Maximum="9999"
                                       FormatString="0"/>
                    </StackPanel>
                    
                    <!-- Hesaplanan Tutar -->
                    <Border Background="#333" CornerRadius="5" Padding="15,10" IsVisible="{Binding SelectedKapTipi, Converter={x:Static ObjectConverters.IsNotNull}}">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <TextBlock Text="Toplam Tutar: " Foreground="Gray" VerticalAlignment="Center"/>
                            <TextBlock FontSize="20" FontWeight="Bold" Foreground="#4CAF50" VerticalAlignment="Center">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="â‚º{0:N2}">
                                        <Binding Path="SelectedKapTipi.RehinBedeli"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                            <TextBlock Text=" x " Foreground="Gray" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding KasaAdet}" FontWeight="Bold" VerticalAlignment="Center"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Butonlar -->
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10" Margin="0,10,0,0">
                        <Button Content="Ä°ptal" 
                                Command="{Binding RehinIptalCommand}"
                                Padding="20,10"/>
                        <Button Content="âœ“ Kaydet" 
                                Command="{Binding RehinKaydetCommand}"
                                Background="#4CAF50"
                                Foreground="White"
                                FontWeight="Bold"
                                Padding="30,10"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>

<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:NeoHal.Desktop.ViewModels"
             xmlns:entities="using:NeoHal.Core.Entities"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="1100" d:DesignHeight="700"
             x:Class="NeoHal.Desktop.Views.SevkiyatGirisView"
             x:DataType="vm:SevkiyatGirisViewModel">
    
    <Grid RowDefinitions="Auto,Auto,Auto,*,Auto,Auto">
        
        <!-- Ãœst Bar - BaÅŸlÄ±k -->
        <Border Grid.Row="0" Background="{DynamicResource BackgroundMediumBrush}" Padding="20,15" BorderBrush="#E5E5E5" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="*,Auto">
                <StackPanel>
                    <TextBlock Text="ðŸš› ÅžUBEYE SATIÅž FATURASI" FontSize="24" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    <TextBlock Text="Åžubeyi seÃ§ â†’ MallarÄ± gir â†’ Fatura kes" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="13"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
                    <Button Content="ðŸ“‚ Taslaklar" Command="{Binding TaslakPaneliAcKapatCommand}" 
                            Background="{DynamicResource WarningBrush}" Foreground="White" Padding="12,8"
                            ToolTip.Tip="YarÄ±m kalan faturalarÄ± gÃ¶ster"/>
                    <Button Content="ðŸ“„ Yeni (F3)" Command="{Binding YeniCommand}" 
                            Background="{DynamicResource PrimaryBrush}" Foreground="White" Padding="12,8"/>
                    <Button Content="ðŸ’¾ Taslak Kaydet (F5)" Command="{Binding KaydetCommand}" 
                            Background="#388E3C" Foreground="White" Padding="12,8"/>
                    <Button x:Name="FaturaKesButton" Content="âœ‚ï¸ FATURA KES" 
                            Command="{Binding FaturaKesCommand}"
                            Background="#D32F2F" Foreground="White" Padding="20,10" 
                            FontWeight="Bold" FontSize="14"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- Taslak Faturalar Paneli -->
        <Border Grid.Row="1" Background="White" Padding="10" 
                IsVisible="{Binding TaslakPanelAcik}" BorderBrush="#E5E5E5" BorderThickness="0,0,0,1">
            <Grid RowDefinitions="Auto,Auto">
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <TextBlock Text="ðŸ“‚ YARIM KALAN FATURALAR" FontWeight="Bold" Foreground="{DynamicResource WarningBrush}" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding TaslakFaturalar.Count, StringFormat='({0} taslak)'}" Foreground="{DynamicResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                </StackPanel>
                <ItemsControl Grid.Row="1" ItemsSource="{Binding TaslakFaturalar}" Margin="0,10,0,0">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="entities:SatisFaturasi">
                            <Border Background="White" CornerRadius="5" Padding="10" Margin="5" BorderBrush="#E0E0E0" BorderThickness="1">
                                <Grid ColumnDefinitions="*,Auto">
                                    <StackPanel>
                                        <TextBlock Text="{Binding FaturaNo}" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                        <TextBlock Text="{Binding FaturaTarihi, StringFormat=dd.MM.yyyy}" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                                        <TextBlock Text="{Binding GenelToplam, StringFormat={}{0:N2} â‚º}" Foreground="{DynamicResource SuccessBrush}" FontWeight="Bold"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="5" VerticalAlignment="Center" Margin="10,0,0,0">
                                        <Button Content="ðŸ“‚" ToolTip.Tip="YÃ¼kle" 
                                                Command="{Binding $parent[UserControl].((vm:SevkiyatGirisViewModel)DataContext).TaslakYukleCommand}"
                                                CommandParameter="{Binding}"
                                                Background="{DynamicResource WarningBrush}" Foreground="White" Padding="8,4"/>
                                        <Button Content="ðŸ—‘" ToolTip.Tip="Sil"
                                                Command="{Binding $parent[UserControl].((vm:SevkiyatGirisViewModel)DataContext).TaslakSilCommand}"
                                                CommandParameter="{Binding}"
                                                Background="#F44336" Foreground="White" Padding="8,4"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Grid>
        </Border>
        
        <!-- Fatura Bilgileri -->
        <Border Grid.Row="2" Background="White" Padding="15" BorderBrush="#E5E5E5" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto,200,30,Auto,200,30,Auto,200,30,Auto,*">
                <TextBlock Text="Åžube:" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold"/>
                <ComboBox Grid.Column="1" 
                          x:Name="SubeComboBox"
                          ItemsSource="{Binding Subeler}"
                          SelectedItem="{Binding SelectedSube}"
                          PlaceholderText="Åžube seÃ§ (F2)"
                          IsTextSearchEnabled="True">
                    <ComboBox.ItemTemplate>
                        <DataTemplate x:DataType="entities:CariHesap">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <TextBlock Text="{Binding Kod}" Foreground="{DynamicResource TextSecondaryBrush}" Width="60"/>
                                <TextBlock Text="{Binding Unvan}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </StackPanel>
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
                
                <TextBlock Grid.Column="3" Text="Tarih:" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold"/>
                <DatePicker Grid.Column="4" SelectedDate="{Binding FaturaTarihi}" MinWidth="240"/>
                
                <TextBlock Grid.Column="6" Text="Fatura No:" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold"/>
                <TextBox Grid.Column="7" Text="{Binding FaturaNo}" IsReadOnly="True" Background="White" Foreground="Black"/>
                
                <TextBlock Grid.Column="9" Text="Durum:" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold"/>
                <TextBlock Grid.Column="10" Text="{Binding SubeDurumMesaji}" Foreground="{Binding SubeDurumRenk}" 
                           VerticalAlignment="Center" Margin="10,0,0,0" FontWeight="SemiBold"/>
            </Grid>
        </Border>
        
        <!-- ANA TABLO - Excel TarzÄ± DataGrid -->
        <Border Grid.Row="3" Background="White" Padding="10">
            <DataGrid ItemsSource="{Binding Kalemler}"
                      SelectedItem="{Binding SelectedKalem}"
                      AutoGenerateColumns="False"
                      CanUserResizeColumns="True"
                      CanUserReorderColumns="False"
                      GridLinesVisibility="All"
                      BorderThickness="1"
                      BorderBrush="#E0E0E0"
                      IsReadOnly="False"
                      SelectionMode="Single"
                      Background="White"
                      RowBackground="White"
                      x:Name="MainDataGrid">
                
                <DataGrid.Columns>
                    <!-- ÃœRÃœN -->
                    <DataGridTemplateColumn Header="ÃœrÃ¼n" Width="180">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="vm:SevkiyatKalem">
                                <StackPanel Orientation="Horizontal" Spacing="5" Margin="8,4">
                                    <TextBlock Text="{Binding Urun.Kod}" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                                    <TextBlock Text="{Binding UrunAdi}" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate x:DataType="vm:SevkiyatKalem">
                                <AutoCompleteBox ItemsSource="{Binding $parent[DataGrid].((vm:SevkiyatGirisViewModel)DataContext).Urunler}"
                                                 SelectedItem="{Binding Urun}"
                                                 FilterMode="ContainsOrdinal"
                                                 MinimumPrefixLength="0"
                                                 Watermark="Yaz: PAT, BIB..."
                                                 ValueMemberBinding="{Binding Ad}">
                                    <AutoCompleteBox.ItemTemplate>
                                        <DataTemplate x:DataType="entities:Urun">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding Kod}" Foreground="{DynamicResource SuccessBrush}" Width="50" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding Ad}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </AutoCompleteBox.ItemTemplate>
                                </AutoCompleteBox>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- KAP TÄ°PÄ° -->
                    <DataGridTemplateColumn Header="Kap Tipi" Width="120">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="vm:SevkiyatKalem">
                                <TextBlock Text="{Binding KapTipiAdi}" Padding="8,4" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}"/>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                        <DataGridTemplateColumn.CellEditingTemplate>
                            <DataTemplate x:DataType="vm:SevkiyatKalem">
                                <AutoCompleteBox ItemsSource="{Binding $parent[DataGrid].((vm:SevkiyatGirisViewModel)DataContext).KapTipleri}"
                                                 SelectedItem="{Binding KapTipi}"
                                                 FilterMode="ContainsOrdinal"
                                                 MinimumPrefixLength="0"
                                                 Watermark="KÃœÃ‡, PLA..."
                                                 ValueMemberBinding="{Binding Ad}">
                                    <AutoCompleteBox.ItemTemplate>
                                        <DataTemplate x:DataType="entities:KapTipi">
                                            <StackPanel Orientation="Horizontal" Spacing="8">
                                                <TextBlock Text="{Binding Kod}" Foreground="{DynamicResource WarningBrush}" Width="40"/>
                                                <TextBlock Text="{Binding Ad}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </AutoCompleteBox.ItemTemplate>
                                </AutoCompleteBox>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellEditingTemplate>
                    </DataGridTemplateColumn>
                    
                    <!-- KAP ADET -->
                    <DataGridTextColumn Header="Kap Ad." Width="70" 
                                        Binding="{Binding KapAdet}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    
                    <!-- DARALI KG (Kasayla birlikte) -->
                    <DataGridTextColumn Header="DaralÄ± Kg" Width="100"
                                        Binding="{Binding DaraliKg, StringFormat=N2}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    
                    <!-- NET KG (Otomatik: DaralÄ± - KapÃ—Dara) -->
                    <DataGridTextColumn Header="Net Kg" Width="90"
                                        Binding="{Binding NetKg, StringFormat=N2}"
                                        IsReadOnly="True"
                                        Foreground="{DynamicResource SuccessBrush}"/>
                    
                    <!-- BÄ°RÄ°M FÄ°YAT -->
                    <DataGridTextColumn Header="Fiyat (â‚º)" Width="100"
                                        Binding="{Binding BirimFiyat, StringFormat=N2}" Foreground="{DynamicResource TextPrimaryBrush}"/>
                    
                    <!-- TUTAR (Otomatik) -->
                    <DataGridTextColumn Header="Tutar (â‚º)" Width="120"
                                        Binding="{Binding Tutar, StringFormat=N2}"
                                        IsReadOnly="True"
                                        Foreground="{DynamicResource WarningBrush}"
                                        FontWeight="Bold"/>
                    
                    <!-- KOPYALA ve SÄ°L ButonlarÄ± -->
                    <DataGridTemplateColumn Header="" Width="80">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate x:DataType="vm:SevkiyatKalem">
                                <StackPanel Orientation="Horizontal" Spacing="2">
                                    <Button Content="ðŸ“‹" 
                                            Command="{Binding $parent[DataGrid].((vm:SevkiyatGirisViewModel)DataContext).KopyalaKalemCommand}"
                                            CommandParameter="{Binding}"
                                            Background="Transparent"
                                            Foreground="{DynamicResource InfoBrush}"
                                            ToolTip.Tip="SatÄ±rÄ± Kopyala"
                                            Padding="5"/>
                                    <Button Content="ðŸ—‘" 
                                            Command="{Binding $parent[DataGrid].((vm:SevkiyatGirisViewModel)DataContext).SilKalemCommand}"
                                            CommandParameter="{Binding}"
                                            Background="Transparent"
                                            Foreground="{DynamicResource ErrorBrush}"
                                            ToolTip.Tip="SatÄ±rÄ± Sil"
                                            Padding="5"/>
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                </DataGrid.Columns>
            </DataGrid>
        </Border>
        
        <!-- Alt Ã–zet - Masraflar -->
        <Border Grid.Row="4" Background="White" Padding="15" BorderBrush="#E5E5E5" BorderThickness="0,1,0,0">
            <Grid ColumnDefinitions="Auto,150,30,Auto,300,*,Auto,Auto,Auto,Auto,Auto">
                <!-- Sol: Masraf Ekleme -->
                <TextBlock Text="Ek Masraflar:" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold"/>
                <NumericUpDown Grid.Column="1" 
                               Value="{Binding EkMasraflar}" 
                               Minimum="0" Maximum="999999"
                               FormatString="N2" 
                               Increment="10"/>
                
                <TextBlock Grid.Column="3" Text="AÃ§Ä±klama:" VerticalAlignment="Center" Foreground="{DynamicResource TextPrimaryBrush}" FontWeight="Bold"/>
                <TextBox Grid.Column="4" 
                         Text="{Binding MasrafAciklamasi}" 
                         Watermark="Nakliye, Hamaliye, vb."
                         Background="White" Foreground="Black"/>
                
                <!-- SaÄŸ: Toplamlar -->
                <StackPanel Grid.Column="6" Margin="0,0,20,0">
                    <TextBlock Text="Toplam Kap" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                    <TextBlock Text="{Binding ToplamKap}" FontSize="18" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                </StackPanel>
                <StackPanel Grid.Column="7" Margin="0,0,20,0">
                    <TextBlock Text="Toplam Kg" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                    <TextBlock Text="{Binding ToplamKg, StringFormat=N2}" FontSize="18" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                </StackPanel>
                <StackPanel Grid.Column="8" Margin="0,0,20,0">
                    <TextBlock Text="Mal TutarÄ±" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                    <TextBlock Text="{Binding AraToplam, StringFormat=â‚º{0:N2}}" FontSize="18" Foreground="{DynamicResource InfoBrush}"/>
                </StackPanel>
                <StackPanel Grid.Column="9" Margin="0,0,20,0">
                    <TextBlock Text="+ Masraf" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                    <TextBlock Text="{Binding EkMasraflar, StringFormat=â‚º{0:N2}}" FontSize="18" Foreground="{DynamicResource WarningBrush}"/>
                </StackPanel>
                <StackPanel Grid.Column="10">
                    <TextBlock Text="GENEL TOPLAM" Foreground="{DynamicResource SuccessBrush}" FontSize="11" FontWeight="Bold"/>
                    <TextBlock Text="{Binding GenelToplam, StringFormat=â‚º{0:N2}}" 
                               FontSize="24" FontWeight="Bold" Foreground="{DynamicResource SuccessBrush}"/>
                </StackPanel>
            </Grid>
        </Border>
        
        <!-- En Alt: KÄ±sayol Bilgisi -->
        <Border Grid.Row="5" Background="White" Padding="10,8" BorderBrush="#E5E5E5" BorderThickness="0,1,0,0">
            <Grid ColumnDefinitions="*,Auto">
                <TextBlock Text="F2: Åžube | F3: Yeni | F5: Kaydet | Enter: SatÄ±r GeÃ§ | âœ‚ï¸ FATURA KES: Kaydet + YazdÄ±r"
                           Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                <Button Grid.Column="1" Content="+ Yeni SatÄ±r (Enter)" Command="{Binding YeniSatirCommand}"
                        Background="{DynamicResource BackgroundDarkBrush}" Foreground="{DynamicResource TextPrimaryBrush}" Padding="15,5"/>
            </Grid>
        </Border>
        
        <!-- Fatura Kes Dialog Overlay -->
        <Border Grid.RowSpan="5" 
                Background="#80000000"
                IsVisible="{Binding FaturaKesDialogAcik}"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch">
            <Border Background="White" 
                    CornerRadius="10"
                    Padding="30"
                    HorizontalAlignment="Center"
                    VerticalAlignment="Center"
                    MinWidth="400">
                <StackPanel Spacing="20">
                    <TextBlock Text="âœ… FATURA KESÄ°LDÄ°" FontSize="24" FontWeight="Bold" 
                               Foreground="{DynamicResource SuccessBrush}" HorizontalAlignment="Center"/>
                    
                    <TextBlock Text="{Binding SonKesilenFaturaNo, StringFormat='Fatura No: {0}'}" 
                               FontSize="18" Foreground="{DynamicResource TextPrimaryBrush}" HorizontalAlignment="Center"/>
                    
                    <TextBlock Text="FaturayÄ± yazdÄ±rmak istiyor musunuz?" 
                               FontSize="14" Foreground="{DynamicResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                    
                    <StackPanel Orientation="Horizontal" Spacing="15" HorizontalAlignment="Center">
                        <Button Content="ðŸ–¨ï¸ YAZDIR" 
                                Command="{Binding FaturaYazdirCommand}"
                                Background="{DynamicResource SuccessBrush}" Foreground="White" 
                                Padding="25,12" FontWeight="Bold" FontSize="14"/>
                        <Button Content="ðŸ“„ PDF Ã–NÄ°ZLEME" 
                                Command="{Binding FaturaPdfOnizleCommand}"
                                Background="{DynamicResource InfoBrush}" Foreground="White" 
                                Padding="25,12" FontWeight="Bold" FontSize="14"/>
                    </StackPanel>
                    
                    <Button Content="HayÄ±r, Kapat" 
                            Command="{Binding FaturaDialogKapatCommand}"
                            Background="{DynamicResource BackgroundLightBrush}" Foreground="{DynamicResource TextPrimaryBrush}" 
                            Padding="20,10" HorizontalAlignment="Center"/>
                </StackPanel>
            </Border>
        </Border>
    </Grid>
</UserControl>
